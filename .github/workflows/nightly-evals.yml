name: Nightly RAG Evaluations

on:
  schedule:
    # Run every night at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  evaluate:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build Next.js app
        run: npm run build
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          HASH_SALT: ${{ secrets.HASH_SALT }}
          SENTRY_DSN: ${{ secrets.SENTRY_DSN }}
          NEXT_PUBLIC_SENTRY_DSN: ${{ secrets.NEXT_PUBLIC_SENTRY_DSN }}

      - name: Start Next.js server
        run: |
          npm run start &
          # Wait for server to be ready
          npx wait-on http://localhost:3000 --timeout 60000
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          HASH_SALT: ${{ secrets.HASH_SALT }}
          SENTRY_DSN: ${{ secrets.SENTRY_DSN }}
          NEXT_PUBLIC_SENTRY_DSN: ${{ secrets.NEXT_PUBLIC_SENTRY_DSN }}

      - name: Run evaluations
        id: evals
        run: npm run evals
        env:
          API_URL: http://localhost:3000

      - name: Upload evaluation results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: eval-results-${{ github.run_number }}
          path: |
            eval-results.json
            eval-summary.txt
          retention-days: 30

      - name: Check for severe regressions
        if: always()
        run: |
          # Read the evaluation results
          if [ -f eval-results.json ]; then
            # Extract quality score (assuming it's in the JSON)
            QUALITY=$(jq -r '.overall_quality // 0' eval-results.json)
            THRESHOLD=0.5

            echo "Quality score: $QUALITY"
            echo "Threshold: $THRESHOLD"

            # Fail only on severe regressions (< 50% quality)
            if (( $(echo "$QUALITY < $THRESHOLD" | bc -l) )); then
              echo "❌ SEVERE REGRESSION DETECTED: Quality score ($QUALITY) below threshold ($THRESHOLD)"
              exit 1
            else
              echo "✅ Quality check passed"
            fi
          else
            echo "⚠️  No evaluation results found"
            exit 1
          fi

      - name: Comment on latest commit (on failure)
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let summary = 'Nightly evaluations failed. Check the artifacts for details.';

            if (fs.existsSync('eval-summary.txt')) {
              summary = fs.readFileSync('eval-summary.txt', 'utf8');
            }

            github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha,
              body: `## ❌ Nightly Evaluations Failed\n\n${summary}\n\n[View workflow run](${context.payload.repository.html_url}/actions/runs/${context.runId})`
            });
